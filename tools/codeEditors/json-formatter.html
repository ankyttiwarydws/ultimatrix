<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JSON Formatter Test</title>
  <link rel="stylesheet" href="/css/style.css" />
  <script src="/js/script.js" defer></script>  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #1e1e1e;
      color: white;
    }
    .controls {
      margin: 20px 0;
    }
    button {
      padding: 10px 16px;
      margin: 5px;
      border-radius: 8px;
      border: none;
      background: #667eea;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #5a67d8;
    }
    .editor-container {
      position: relative;
      width: 100%;
      height: 400px;
      background: #282c34;
      border: 1px solid #4a5568;
      border-radius: 8px;
      overflow: hidden;
    }
    .line-numbers {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 100%;
      background: #1a202c;
      border-right: 1px solid #4a5568;
      color: #718096;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      padding: 15px 5px;
      text-align: right;
      overflow-y: hidden;
      user-select: none;
      box-sizing: border-box;
      white-space: pre;
    }
    .editor {
      position: absolute;
      left: 50px;
      top: 0;
      width: calc(100% - 50px);
      height: 100%;
      background: transparent;
      color: white;
      border: none;
      border-radius: 0;
      padding: 15px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      outline: none;
      box-sizing: border-box;
    }
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: none;
    }
    .error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: #ff6b6b;
    }
    .success {
      background: rgba(46, 213, 115, 0.1);
      border: 1px solid rgba(46, 213, 115, 0.3);
      color: #2ed573;
    }
    .stats {
      display: flex;
      gap: 15px;
      margin: 10px 0;
      font-size: 12px;
      color: #a0aec0;
    }
    .stat {
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    /* Compare Mode Styles */
    .compare-container {
      margin-top: 30px;
      padding: 20px;
      background: #2d3748;
      border-radius: 8px;
      border: 1px solid #4a5568;
    }
    
    .compare-container h3 {
      margin-top: 0;
      color: #e2e8f0;
    }
    
    .compare-editors {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .compare-editor-wrapper {
      display: flex;
      flex-direction: column;
    }
    
    .compare-editor-wrapper label {
      margin-bottom: 10px;
      color: #e2e8f0;
      font-weight: bold;
    }
    
    .compare-controls {
      margin-bottom: 20px;
    }
    
    .compare-result {
      padding: 15px;
      background: #1a202c;
      border-radius: 5px;
      border: 1px solid #4a5568;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    
    /* Tree View Styles */
    .tree-container {
      margin-top: 30px;
      padding: 20px;
      background: #2d3748;
      border-radius: 8px;
      border: 1px solid #4a5568;
    }
    
    .tree-container h3 {
      margin-top: 0;
      color: #e2e8f0;
    }
    
    .tree-controls {
      margin-bottom: 20px;
    }
    
    .tree-view {
      padding: 15px;
      background: #1a202c;
      border-radius: 5px;
      border: 1px solid #4a5568;
      font-family: monospace;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .tree-node {
      margin: 2px 0;
      cursor: pointer;
    }
    
    .tree-node:hover {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    
    .tree-toggle {
      display: inline-block;
      width: 16px;
      height: 16px;
      text-align: center;
      line-height: 16px;
      margin-right: 5px;
      background: #4a5568;
      border-radius: 2px;
      color: white;
      font-size: 10px;
      cursor: pointer;
    }
    
    .tree-toggle:hover {
      background: #667eea;
    }
    
    .tree-content {
      margin-left: 20px;
      display: none;
    }
    
    .tree-content.expanded {
      display: block;
    }
    
    .tree-key {
      color: #90cdf4;
      font-weight: bold;
    }
    
    .tree-value {
      color: #f7fafc;
    }
    
    .tree-type {
      color: #68d391;
      font-style: italic;
    }
    
    .tree-path {
      color: #a0aec0;
      font-size: 12px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div id="header"></div>
  <h1>JSON Formatter Test</h1>
  
  <div class="controls">
    <button onclick="formatJSON()">Format JSON</button>
    <button onclick="validateJSON()">Validate JSON</button>
    <button onclick="minifyJSON()">Minify JSON</button>
    <button onclick="loadSample()">Load Sample</button>
    <button onclick="clearJSON()">Clear</button>
    <button onclick="addMissingSymbols()">Add Missing Symbols</button>
    <button onclick="sortKeys()">Sort Keys</button>
    <button onclick="copyJSON()">Copy JSON</button>
    <button onclick="downloadJSON()">Download JSON</button>
    <button onclick="toggleCompareMode()">Compare Mode</button>
    <button onclick="toggleTreeView()">Tree View</button>
  </div>

  <div class="stats">
    <span class="stat" id="charCount">0 chars</span>
    <span class="stat" id="lineCount">0 lines</span>
    <span class="stat" id="sizeBytes">0 bytes</span>
  </div>

  <div id="errorMessage" class="message error"></div>
  <div id="successMessage" class="message success"></div>

  <div class="editor-container">
    <div class="line-numbers" id="lineNumbers"></div>
    <textarea id="editor1" class="editor" placeholder="Paste your JSON here..."></textarea>
  </div>

  <!-- Compare Mode Container -->
  <div id="compareContainer" class="compare-container" style="display: none;">
    <h3>Compare JSON</h3>
    <div class="compare-editors">
      <div class="compare-editor-wrapper">
        <label>Original JSON:</label>
        <div class="editor-container">
          <div class="line-numbers" id="lineNumbers2"></div>
          <textarea id="editor2" class="editor" placeholder="Original JSON..."></textarea>
        </div>
      </div>
      <div class="compare-editor-wrapper">
        <label>Modified JSON:</label>
        <div class="editor-container">
          <div class="line-numbers" id="lineNumbers3"></div>
          <textarea id="editor3" class="editor" placeholder="Modified JSON..."></textarea>
        </div>
      </div>
    </div>
    <div class="compare-controls">
      <button onclick="compareJSON()">Compare</button>
      <button onclick="swapJSON()">Swap</button>
      <button onclick="mergeJSON()">Merge</button>
    </div>
    <div id="compareResult" class="compare-result"></div>
  </div>

  <!-- Tree View Container -->
  <div id="treeContainer" class="tree-container" style="display: none;">
    <h3>JSON Tree View</h3>
    <div class="tree-controls">
      <button onclick="expandAll()">Expand All</button>
      <button onclick="collapseAll()">Collapse All</button>
      <button onclick="copyPath()">Copy Path</button>
    </div>
    <div id="treeView" class="tree-view"></div>
  </div>

  <script>
    let currentJSON = null;

    function getEditorContent(editor) {
      return editor.value || '';
    }

    function setEditorContent(editor, content) {
      editor.value = content;
      updateLineNumbers();
      updateStats();
    }

    function updateLineNumbers() {
      const editor = document.getElementById("editor1");
      const lineNumbers = document.getElementById("lineNumbers");
      if (!editor || !lineNumbers) return;
      
      const lines = editor.value.split('\n');
      const lineCount = Math.max(lines.length, 1); // At least 1 line
      
      let lineNumbersHTML = '';
      for (let i = 1; i <= lineCount; i++) {
        lineNumbersHTML += i + '\n';
      }
      
      lineNumbers.innerHTML = lineNumbersHTML;
      
      // Ensure line heights match exactly
      const editorStyle = getComputedStyle(editor);
      lineNumbers.style.lineHeight = editorStyle.lineHeight;
      lineNumbers.style.fontSize = editorStyle.fontSize;
      lineNumbers.style.fontFamily = editorStyle.fontFamily;
    }

    function updateStats() {
      const editor = document.getElementById("editor1");
      if (!editor) return;
      
      const text = getEditorContent(editor);
      const charCount = text.length;
      const lineCount = text.split('\n').length;
      const sizeBytes = new Blob([text]).size;
      
      const charCountEl = document.getElementById("charCount");
      const lineCountEl = document.getElementById("lineCount");
      const sizeBytesEl = document.getElementById("sizeBytes");
      
      if (charCountEl) charCountEl.textContent = `${charCount} chars`;
      if (lineCountEl) lineCountEl.textContent = `${lineCount} lines`;
      if (sizeBytesEl) sizeBytesEl.textContent = `${sizeBytes} bytes`;
    }

    function showMessage(element, message, isError = false) {
      element.textContent = message;
      element.style.display = 'block';
      element.className = isError ? 'message error' : 'message success';
      
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }

    function formatJSON() {
      console.log('formatJSON called');
      try {
        const editor = document.getElementById("editor1");
        console.log('Editor element:', editor);
        if (!editor) return;
        
        const input = getEditorContent(editor);
        console.log('Input content:', input);
        
        if (!input.trim()) {
          showMessage(document.getElementById("errorMessage"), "Please enter some JSON to format", true);
          return;
        }

        const parsed = JSON.parse(input);
        const formatted = JSON.stringify(parsed, null, 4);
        
        setEditorContent(editor, formatted);
        currentJSON = parsed;
        showMessage(document.getElementById("successMessage"), "JSON formatted successfully!");
        
      } catch (error) {
        console.error('Error in formatJSON:', error);
        showMessage(document.getElementById("errorMessage"), `Invalid JSON: ${error.message}`, true);
      }
    }

    function validateJSON() {
      try {
        const editor = document.getElementById("editor1");
        if (!editor) return;
        
        const input = getEditorContent(editor);
        
        if (!input.trim()) {
          showMessage(document.getElementById("errorMessage"), "Please enter some JSON to validate", true);
          return;
        }

        const parsed = JSON.parse(input);
        currentJSON = parsed;
        
        let message = "✅ Valid JSON! ";
        
        if (Array.isArray(parsed)) {
          message += `Array with ${parsed.length} items`;
        } else if (typeof parsed === 'object' && parsed !== null) {
          const keyCount = Object.keys(parsed).length;
          message += `Object with ${keyCount} keys`;
        } else {
          message += `Value: ${typeof parsed}`;
        }
        
        showMessage(document.getElementById("successMessage"), message);
        
      } catch (error) {
        showMessage(document.getElementById("errorMessage"), `❌ Invalid JSON: ${error.message}`, true);
      }
    }

    function minifyJSON() {
      try {
        const editor = document.getElementById("editor1");
        if (!editor) return;
        
        const input = getEditorContent(editor);
        
        if (!input.trim()) {
          showMessage(document.getElementById("errorMessage"), "Please enter some JSON to minify", true);
          return;
        }

        const parsed = JSON.parse(input);
        const minified = JSON.stringify(parsed);
        
        setEditorContent(editor, minified);
        showMessage(document.getElementById("successMessage"), "JSON minified successfully!");
        
      } catch (error) {
        showMessage(document.getElementById("errorMessage"), `Invalid JSON: ${error.message}`, true);
      }
    }

    function addMissingSymbols() {
      try {
        const editor = document.getElementById("editor1");
        if (!editor) return;
        
        let input = getEditorContent(editor);
        
        if (!input.trim()) {
          showMessage(document.getElementById("errorMessage"), "Please enter some JSON to process", true);
          return;
        }

        // Add missing quotes around property names
        input = input.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g, '$1"$2":');
        
        // Add missing quotes around string values
        input = input.replace(/:\s*([a-zA-Z_$][a-zA-Z0-9_$]*)(\s*[,}])/g, ':"$1"$2');
        
        // Add missing commas
        input = input.replace(/([}\]"])\s*([{"])/g, '$1,$2');
        
        // Add missing brackets/braces
        const openBraces = (input.match(/\{/g) || []).length;
        const closeBraces = (input.match(/\}/g) || []).length;
        const openBrackets = (input.match(/\[/g) || []).length;
        const closeBrackets = (input.match(/\]/g) || []).length;
        
        // Add missing closing braces
        for (let i = 0; i < openBraces - closeBraces; i++) {
          input += '}';
        }
        
        // Add missing closing brackets
        for (let i = 0; i < openBrackets - closeBrackets; i++) {
          input += ']';
        }
        
        // Try to parse to validate
        JSON.parse(input);
        
        setEditorContent(editor, input);
        showMessage(document.getElementById("successMessage"), "Missing symbols added!");
        
      } catch (error) {
        showMessage(document.getElementById("errorMessage"), `Failed to add missing symbols: ${error.message}`, true);
      }
    }

    function loadSample() {
      const sampleJSON = {
        "name": "John Doe",
        "age": 30,
        "email": "john.doe@example.com",
        "address": {
          "street": "123 Main St",
          "city": "Anytown",
          "state": "CA",
          "zip": "12345"
        },
        "phoneNumbers": [
          {
            "type": "home",
            "number": "555-123-4567"
          },
          {
            "type": "work",
            "number": "555-987-6543"
          }
        ],
        "isActive": true,
        "lastLogin": "2025-01-15T10:30:00Z"
      };
      
      const editor = document.getElementById("editor1");
      if (editor) {
        setEditorContent(editor, JSON.stringify(sampleJSON, null, 4));
        showMessage(document.getElementById("successMessage"), "Sample JSON loaded!");
      }
    }

    function clearJSON() {
      const editor = document.getElementById("editor1");
      if (editor) {
        setEditorContent(editor, '');
        showMessage(document.getElementById("successMessage"), "Editor cleared!");
      }
    }

    function sortKeys() {
      try {
        const editor = document.getElementById("editor1");
        if (!editor) return;
        
        const input = getEditorContent(editor);
        
        if (!input.trim()) {
          showMessage(document.getElementById("errorMessage"), "Please enter some JSON to sort", true);
          return;
        }

        const parsed = JSON.parse(input);
        const sorted = sortObjectKeys(parsed);
        
        setEditorContent(editor, JSON.stringify(sorted, null, 2));
        showMessage(document.getElementById("successMessage"), "JSON keys sorted successfully!");
        
      } catch (error) {
        showMessage(document.getElementById("errorMessage"), `Error sorting JSON: ${error.message}`, true);
      }
    }

    function sortObjectKeys(obj) {
      if (Array.isArray(obj)) {
        return obj.map(item => sortObjectKeys(item));
      }
      
      if (obj !== null && typeof obj === 'object') {
        const sortedObj = {};
        const keys = Object.keys(obj).sort();
        
        keys.forEach(key => {
          sortedObj[key] = sortObjectKeys(obj[key]);
        });
        
        return sortedObj;
      }
      
      return obj;
    }

    function copyJSON() {
      try {
        const editor = document.getElementById("editor1");
        if (!editor) return;
        
        const input = getEditorContent(editor);
        
        if (!input.trim()) {
          showMessage(document.getElementById("errorMessage"), "Please enter some JSON to copy", true);
          return;
        }

        // Validate JSON before copying
        const parsed = JSON.parse(input);
        const formatted = JSON.stringify(parsed, null, 2);
        
        // Use clipboard API to copy the formatted JSON
        navigator.clipboard.writeText(formatted).then(() => {
          showMessage(document.getElementById("successMessage"), "JSON copied to clipboard successfully!");
        }).catch(() => {
          // Fallback for older browsers
          fallbackCopyTextToClipboard(formatted);
        });
        
      } catch (error) {
        showMessage(document.getElementById("errorMessage"), `Invalid JSON: ${error.message}`, true);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      textArea.style.top = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showMessage(document.getElementById("successMessage"), "JSON copied to clipboard successfully!");
        } else {
          showMessage(document.getElementById("errorMessage"), "Failed to copy JSON to clipboard", true);
        }
      } catch (err) {
        showMessage(document.getElementById("errorMessage"), "Failed to copy JSON to clipboard", true);
      }
      
      document.body.removeChild(textArea);
    }

    function downloadJSON() {
      try {
        const editor = document.getElementById("editor1");
        if (!editor) return;
        
        const input = getEditorContent(editor);
        
        if (!input.trim()) {
          showMessage(document.getElementById("errorMessage"), "Please enter some JSON to download", true);
          return;
        }

        // Validate JSON before downloading
        const parsed = JSON.parse(input);
        const formatted = JSON.stringify(parsed, null, 2);
        
        // Create a blob with the JSON content
        const blob = new Blob([formatted], { type: 'application/json' });
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // Generate filename with timestamp
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        a.download = `json-data-${timestamp}.json`;
        
        // Trigger download
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showMessage(document.getElementById("successMessage"), "JSON downloaded successfully!");
        
      } catch (error) {
        showMessage(document.getElementById("errorMessage"), `Invalid JSON: ${error.message}`, true);
      }
    }

    // Compare Mode Functions
    function toggleCompareMode() {
      const compareContainer = document.getElementById("compareContainer");
      const treeContainer = document.getElementById("treeContainer");
      
      if (compareContainer.style.display === "none") {
        compareContainer.style.display = "block";
        treeContainer.style.display = "none";
        
        // Copy current content to original editor
        const editor1 = document.getElementById("editor1");
        const editor2 = document.getElementById("editor2");
        if (editor1 && editor2) {
          editor2.value = editor1.value;
          updateLineNumbersForEditor(editor2, "lineNumbers2");
        }
      } else {
        compareContainer.style.display = "none";
      }
    }

    function updateLineNumbersForEditor(editor, lineNumbersId) {
      const lineNumbers = document.getElementById(lineNumbersId);
      if (!editor || !lineNumbers) return;
      
      const lines = editor.value.split('\n');
      const lineCount = Math.max(lines.length, 1);
      
      let lineNumbersHTML = '';
      for (let i = 1; i <= lineCount; i++) {
        lineNumbersHTML += i + '\n';
      }
      
      lineNumbers.innerHTML = lineNumbersHTML;
      lineNumbers.style.lineHeight = getComputedStyle(editor).lineHeight;
    }

    function compareJSON() {
      try {
        const editor2 = document.getElementById("editor2");
        const editor3 = document.getElementById("editor3");
        const resultDiv = document.getElementById("compareResult");
        
        if (!editor2 || !editor3 || !resultDiv) return;
        
        const json1 = JSON.parse(editor2.value || '{}');
        const json2 = JSON.parse(editor3.value || '{}');
        
        const differences = findDifferences(json1, json2);
        
        if (differences.length === 0) {
          resultDiv.innerHTML = '<span style="color: #68d391;">✅ No differences found!</span>';
        } else {
          let resultHTML = '<h4>Differences Found:</h4>';
          differences.forEach(diff => {
            const color = diff.type === 'added' ? '#68d391' : diff.type === 'removed' ? '#fc8181' : '#f6e05e';
            const icon = diff.type === 'added' ? '➕' : diff.type === 'removed' ? '➖' : '🔄';
            resultHTML += `<div style="color: ${color}; margin: 5px 0;">${icon} ${diff.path}: ${diff.message}</div>`;
          });
          resultDiv.innerHTML = resultHTML;
        }
        
      } catch (error) {
        showMessage(document.getElementById("errorMessage"), `Error comparing JSON: ${error.message}`, true);
      }
    }

    function findDifferences(obj1, obj2, path = '') {
      const differences = [];
      
      if (typeof obj1 !== typeof obj2) {
        differences.push({
          type: 'modified',
          path: path || 'root',
          message: `Type changed from ${typeof obj1} to ${typeof obj2}`
        });
        return differences;
      }
      
      if (Array.isArray(obj1) !== Array.isArray(obj2)) {
        differences.push({
          type: 'modified',
          path: path || 'root',
          message: `Structure changed from ${Array.isArray(obj1) ? 'array' : 'object'} to ${Array.isArray(obj2) ? 'array' : 'object'}`
        });
        return differences;
      }
      
      if (Array.isArray(obj1)) {
        if (obj1.length !== obj2.length) {
          differences.push({
            type: 'modified',
            path: path || 'root',
            message: `Array length changed from ${obj1.length} to ${obj2.length}`
          });
        }
        
        const maxLength = Math.max(obj1.length, obj2.length);
        for (let i = 0; i < maxLength; i++) {
          const currentPath = path ? `${path}[${i}]` : `[${i}]`;
          if (i >= obj1.length) {
            differences.push({
              type: 'added',
              path: currentPath,
              message: `Added: ${JSON.stringify(obj2[i])}`
            });
          } else if (i >= obj2.length) {
            differences.push({
              type: 'removed',
              path: currentPath,
              message: `Removed: ${JSON.stringify(obj1[i])}`
            });
          } else {
            differences.push(...findDifferences(obj1[i], obj2[i], currentPath));
          }
        }
      } else if (typeof obj1 === 'object' && obj1 !== null) {
        const keys1 = Object.keys(obj1);
        const keys2 = Object.keys(obj2);
        
        // Check for removed keys
        keys1.forEach(key => {
          if (!(key in obj2)) {
            differences.push({
              type: 'removed',
              path: path ? `${path}.${key}` : key,
              message: `Removed: ${JSON.stringify(obj1[key])}`
            });
          }
        });
        
        // Check for added keys
        keys2.forEach(key => {
          if (!(key in obj1)) {
            differences.push({
              type: 'added',
              path: path ? `${path}.${key}` : key,
              message: `Added: ${JSON.stringify(obj2[key])}`
            });
          }
        });
        
        // Check for modified values
        keys1.forEach(key => {
          if (key in obj2) {
            differences.push(...findDifferences(obj1[key], obj2[key], path ? `${path}.${key}` : key));
          }
        });
      } else if (obj1 !== obj2) {
        differences.push({
          type: 'modified',
          path: path || 'root',
          message: `Value changed from ${JSON.stringify(obj1)} to ${JSON.stringify(obj2)}`
        });
      }
      
      return differences;
    }

    function swapJSON() {
      const editor2 = document.getElementById("editor2");
      const editor3 = document.getElementById("editor3");
      
      if (editor2 && editor3) {
        const temp = editor2.value;
        editor2.value = editor3.value;
        editor3.value = temp;
        
        updateLineNumbersForEditor(editor2, "lineNumbers2");
        updateLineNumbersForEditor(editor3, "lineNumbers3");
        
        showMessage(document.getElementById("successMessage"), "JSON content swapped!");
      }
    }

    function mergeJSON() {
      try {
        const editor2 = document.getElementById("editor2");
        const editor3 = document.getElementById("editor3");
        const resultDiv = document.getElementById("compareResult");
        
        if (!editor2 || !editor3 || !resultDiv) return;
        
        const json1 = JSON.parse(editor2.value || '{}');
        const json2 = JSON.parse(editor3.value || '{}');
        
        const merged = deepMerge(json1, json2);
        
        resultDiv.innerHTML = '<h4>Merged JSON:</h4><pre style="color: #68d391;">' + 
          JSON.stringify(merged, null, 2) + '</pre>';
        
        // Copy merged result to main editor
        const editor1 = document.getElementById("editor1");
        if (editor1) {
          setEditorContent(editor1, JSON.stringify(merged, null, 2));
        }
        
      } catch (error) {
        showMessage(document.getElementById("errorMessage"), `Error merging JSON: ${error.message}`, true);
      }
    }

    function deepMerge(target, source) {
      const result = { ...target };
      
      for (const key in source) {
        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
          result[key] = deepMerge(result[key] || {}, source[key]);
        } else {
          result[key] = source[key];
        }
      }
      
      return result;
    }

    // Tree View Functions
    function toggleTreeView() {
      const treeContainer = document.getElementById("treeContainer");
      const compareContainer = document.getElementById("compareContainer");
      
      if (treeContainer.style.display === "none") {
        treeContainer.style.display = "block";
        compareContainer.style.display = "none";
        generateTreeView();
      } else {
        treeContainer.style.display = "none";
      }
    }

    function generateTreeView() {
      try {
        const editor = document.getElementById("editor1");
        const treeView = document.getElementById("treeView");
        
        if (!editor || !treeView) return;
        
        const json = JSON.parse(editor.value || '{}');
        const treeHTML = buildTreeHTML(json);
        treeView.innerHTML = treeHTML;
        
        // Add event listeners to tree toggles
        addTreeEventListeners();
        
      } catch (error) {
        const treeView = document.getElementById("treeView");
        if (treeView) {
          treeView.innerHTML = `<span style="color: #fc8181;">Error: ${error.message}</span>`;
        }
      }
    }

    function buildTreeHTML(obj, path = '') {
      if (obj === null) return `<span class="tree-value">null</span>`;
      if (typeof obj === 'undefined') return `<span class="tree-value">undefined</span>`;
      
      if (typeof obj === 'string') {
        return `<span class="tree-value">"${obj}"</span> <span class="tree-type">(string)</span>`;
      }
      if (typeof obj === 'number') {
        return `<span class="tree-value">${obj}</span> <span class="tree-type">(number)</span>`;
      }
      if (typeof obj === 'boolean') {
        return `<span class="tree-value">${obj}</span> <span class="tree-type">(boolean)</span>`;
      }
      
      if (Array.isArray(obj)) {
        if (obj.length === 0) {
          return `<span class="tree-value">[]</span> <span class="tree-type">(empty array)</span>`;
        }
        
        let html = `<span class="tree-toggle" data-path="${path}">▶</span> <span class="tree-value">[${obj.length} items]</span> <span class="tree-type">(array)</span>`;
        html += `<div class="tree-content" data-path="${path}">`;
        
        obj.forEach((item, index) => {
          const itemPath = path ? `${path}[${index}]` : `[${index}]`;
          html += `<div class="tree-node">${buildTreeHTML(item, itemPath)}</div>`;
        });
        
        html += '</div>';
        return html;
      }
      
      if (typeof obj === 'object') {
        const keys = Object.keys(obj);
        if (keys.length === 0) {
          return `<span class="tree-value">{}</span> <span class="tree-type">(empty object)</span>`;
        }
        
        let html = `<span class="tree-toggle" data-path="${path}">▶</span> <span class="tree-value">{${keys.length} keys}</span> <span class="tree-type">(object)</span>`;
        html += `<div class="tree-content" data-path="${path}">`;
        
        keys.forEach(key => {
          const itemPath = path ? `${path}.${key}` : key;
          html += `<div class="tree-node"><span class="tree-key">"${key}":</span> ${buildTreeHTML(obj[key], itemPath)} <span class="tree-path">${itemPath}</span></div>`;
        });
        
        html += '</div>';
        return html;
      }
      
      return `<span class="tree-value">${obj}</span>`;
    }

    function addTreeEventListeners() {
      const toggles = document.querySelectorAll('.tree-toggle');
      toggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
          const path = this.getAttribute('data-path');
          const content = document.querySelector(`.tree-content[data-path="${path}"]`);
          
          if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            this.textContent = '▶';
          } else {
            content.classList.add('expanded');
            this.textContent = '▼';
          }
        });
      });
    }

    function expandAll() {
      const contents = document.querySelectorAll('.tree-content');
      const toggles = document.querySelectorAll('.tree-toggle');
      
      contents.forEach(content => content.classList.add('expanded'));
      toggles.forEach(toggle => toggle.textContent = '▼');
    }

    function collapseAll() {
      const contents = document.querySelectorAll('.tree-content');
      const toggles = document.querySelectorAll('.tree-toggle');
      
      contents.forEach(content => content.classList.remove('expanded'));
      toggles.forEach(toggle => toggle.textContent = '▶');
    }

    function copyPath() {
      const activeElement = document.activeElement;
      if (activeElement && activeElement.classList.contains('tree-node')) {
        const pathElement = activeElement.querySelector('.tree-path');
        if (pathElement) {
          const path = pathElement.textContent;
          navigator.clipboard.writeText(path).then(() => {
            showMessage(document.getElementById("successMessage"), `Path copied: ${path}`);
          }).catch(() => {
            showMessage(document.getElementById("errorMessage"), "Failed to copy path", true);
          });
        }
      } else {
        showMessage(document.getElementById("errorMessage"), "Please click on a tree node first", true);
      }
    }

    // Load sample on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded');
      
      const editor = document.getElementById("editor1");
      if (editor) {
        editor.addEventListener('input', function() {
          updateLineNumbers();
          updateStats();
        });
        editor.addEventListener('scroll', function() {
          const lineNumbers = document.getElementById("lineNumbers");
          if (lineNumbers) {
            lineNumbers.scrollTop = editor.scrollTop;
          }
        });
      }
      
      // Add event listeners for compare mode editors
      const editor2 = document.getElementById("editor2");
      const editor3 = document.getElementById("editor3");
      
      if (editor2) {
        editor2.addEventListener('input', function() {
          updateLineNumbersForEditor(editor2, "lineNumbers2");
        });
        editor2.addEventListener('scroll', function() {
          const lineNumbers = document.getElementById("lineNumbers2");
          if (lineNumbers) {
            lineNumbers.scrollTop = editor2.scrollTop;
          }
        });
      }
      
      if (editor3) {
        editor3.addEventListener('input', function() {
          updateLineNumbersForEditor(editor3, "lineNumbers3");
        });
        editor3.addEventListener('scroll', function() {
          const lineNumbers = document.getElementById("lineNumbers3");
          if (lineNumbers) {
            lineNumbers.scrollTop = editor3.scrollTop;
          }
        });
      }
      
      loadSample();
    });
  </script>
  <div id="footer"></div>
</body>
</html>
